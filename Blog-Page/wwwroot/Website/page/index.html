<!DOCTYPE html><html lang="en" class="theme-dark audio-muted graphics-full"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><title>Protecting Next.js API Routes: Query Parameters - James Warner</title><meta name="author" content="James Warner"><meta name="description" content="How to protect the query parameters of your Next.js API routes from malicious use."><link rel="canonical" href="https://jmswrnr.com/blog/protecting-next-js-api-routes-query-parameters"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@jmswrnr"><meta name="twitter:title" content="Protecting Next.js API Routes: Query Parameters"><meta name="twitter:description" content="How to protect the query parameters of your Next.js API routes from malicious use."><meta name="twitter:image" content="https://jmswrnr.com/avatar-120.png"><meta name="twitter:creator" content="@jmswrnr"><meta property="og:type" content="article"><meta property="og:url" content="https://jmswrnr.com/blog/protecting-next-js-api-routes-query-parameters"><meta property="og:title" content="Protecting Next.js API Routes: Query Parameters"><meta property="og:description" content="How to protect the query parameters of your Next.js API routes from malicious use."><meta property="og:image" content="images/avatar-200.png"><meta property="og:image:width" content="200"><meta property="og:image:height" content="200"><meta property="og:site_name" content="James Warner"><meta property="article:published_time" content="2023-02-23T16:09:52.402Z"><meta property="article:modified_time" content="2023-02-23T18:05:29Z"><meta property="article:author" content="https://jmswrnr.com/about"><meta property="article:tag" content="Tutorial"><script type="application/ld+json">{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://jmswrnr.com#organization","name":"JMSWRNR","url":"https://jmswrnr.com","sameAs":["https://twitter.com/jmswrnr","https://github.com/jmswrnr"],"logo":{"@type":"ImageObject","@id":"https://jmswrnr.com#logo","url":"https://jmswrnr.com/avatar-120.png","width":120,"height":120,"caption":"James Warner"},"image":{"@id":"https://jmswrnr.com#logo"}},{"@type":"WebSite","@id":"https://jmswrnr.com#website","url":"https://jmswrnr.com","name":"James Warner","description":"üë®üèª‚Äçüíª Creative Technologist","publisher":{"@id":"https://jmswrnr.com#organization"}},{"@type":"WebPage","@id":"https://jmswrnr.com/blog/protecting-next-js-api-routes-query-parameters#webpage","url":"https://jmswrnr.com/blog/protecting-next-js-api-routes-query-parameters","inLanguage":"en-US","name":"Protecting Next.js API Routes: Query Parameters","datePublished":"2023-02-23T16:09:52.402Z","dateModified":"2023-02-23T18:05:29Z","description":"How to protect the query parameters of your Next.js API routes from malicious use.","isPartOf":{"@id":"https://jmswrnr.com#website"},"about":{"@id":"https://jmswrnr.com#organization"}},{"@type":"BreadcrumbList","@id":"https://jmswrnr.com/blog/protecting-next-js-api-routes-query-parameters#breadcrumb","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://jmswrnr.com/blog#webpage","url":"https://jmswrnr.com/blog","name":"Blog"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://jmswrnr.com/blog/protecting-next-js-api-routes-query-parameters#webpage","url":"https://jmswrnr.com/blog/protecting-next-js-api-routes-query-parameters","name":"Protecting Next.js API Routes: Query Parameters"}}]},{"@type":"Article","headline":"Protecting Next.js API Routes: Query Parameters","datePublished":"2023-02-23T16:09:52.402Z","dateModified":"2023-02-23T18:05:29Z","author":{"@type":"Person","@id":"https://jmswrnr.com/about#person","name":"James Warner"},"mainEntityOfPage":{"@id":"https://jmswrnr.com/blog/protecting-next-js-api-routes-query-parameters#webpage"},"isPartOf":{"@id":"https://jmswrnr.com/blog/protecting-next-js-api-routes-query-parameters#webpage"},"publisher":{"@id":"https://jmswrnr.com#organization"},"image":{"@id":"https://jmswrnr.com/blog/protecting-next-js-api-routes-query-parameters#primaryimage"},"description":"How to protect the query parameters of your Next.js API routes from malicious use."}]}</script><meta name="next-head-count" content="9"><link rel="icon" href="images/favicon-32.png" sizes="32x32"><link rel="icon" href="images/favicon-128.png" sizes="128x128"><link rel="icon" href="images/favicon-192.png" sizes="192x192"><link rel="shortcut icon" href="images/favicon-196.png" sizes="196x196"><link rel="apple-touch-icon" href="images/favicon-152.png" sizes="152x152"><link rel="apple-touch-icon" href="images/favicon-167.png" sizes="152x152"><link rel="apple-touch-icon" href="images/favicon-180.png" sizes="180x180"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preload" href="/_next/static/media/79da84d9e972ee51.p.woff2" as="font" type="font/woff2" crossorigin="anonymous"><link rel="preload" href="/_next/static/media/74855af1e5bcab1c.p.woff2" as="font" type="font/woff2" crossorigin="anonymous"><link rel="preload" href="/_next/static/media/86fdec36ddd9097e.p.woff2" as="font" type="font/woff2" crossorigin="anonymous"><link rel="preload" href="/_next/static/css/7969056fec6838c4.css" as="style"><link rel="stylesheet" href="css/7969056fec6838c4.css" data-n-g><link rel="preload" href="/_next/static/css/81d62c7342faaeee.css" as="style"><link rel="stylesheet" href="css/81d62c7342faaeee.css" data-n-p><noscript data-n-css></noscript><script defer nomodule src="js/polyfills-c67a75d1b6f99dc8.js"></script><script src="js/webpack-154b6e4648b7add1.js" defer></script><script src="js/framework-ce84985cd166733a.js" defer></script><script src="js/main-52d0159cdcd1b4c4.js" defer></script><script src="js/_app-3327d13271f8dddf.js" defer></script><script src="js/6396-b682762ccfb776ed.js" defer></script><script src="js/4909-22d3c8dea6424cf2.js" defer></script><script src="js/%5Bpost_slug%5D-a0d3b9a6c5cc23d8.js" defer></script><script src="js/_buildManifest.js" defer></script><script src="js/_ssgManifest.js" defer></script><style id="__jsx-3398092431">:root{--font-family-blender:'__BlenderPro_54dc17', '__BlenderPro_Fallback_54dc17';--font-family-jetbrainsmono:'__JetBrains_Mono_31efa5', '__JetBrains_Mono_Fallback_31efa5'}</style><style data-href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@20..48,400,1,0&display=block">@font-face{font-family:'Material Symbols Sharp';font-style:normal;font-weight:400;font-display:block;src:url(fonts/gNNBW2J8Roq16WD5tFNRaeLQk6-SHQ_R00k4c2_whPnoY9ruReYU3rHmz74m0ZkGH-VBYe1x0TV6x4yFH8F-H_OdzEL3sVTgJtfbYxOLojCN.woff) format('woff')}@font-face{font-family:'Material Symbols Sharp';font-style:normal;font-weight:400;font-display:block;src:url(fonts/gNNBW2J8Roq16WD5tFNRaeLQk6-SHQ_R00k4c2_whPnoY9ruReYU3rHmz74m0ZkGH-VBYe1x0TV6x4yFH8F-H5OdzEL3sVTgJtfbYxOLojCN.woff) format('woff')}@font-face{font-family:'Material Symbols Sharp';font-style:normal;font-weight:400;font-display:block;src:url(fonts/gNNBW2J8Roq16WD5tFNRaeLQk6-SHQ_R00k4c2_whPnoY9ruReYU3rHmz74m0ZkGH-VBYe1x0TV6x4yFH8F-H7OdzEL3sVTgJtfbYxOLojCN.woff) format('woff')}@font-face{font-family:'Material Symbols Sharp';font-style:normal;font-weight:400;font-display:block;src:url(fonts/gNNBW2J8Roq16WD5tFNRaeLQk6-SHQ_R00k4c2_whPnoY9ruReYU3rHmz74m0ZkGH-VBYe1x0TV6x4yFH8F-H0OezEL3sVTgJtfbYxOLojCN.woff) format('woff')}@font-face{font-family:'Material Symbols Sharp';font-style:normal;font-weight:400;font-display:block;src:url(fonts/gNNBW2J8Roq16WD5tFNRaeLQk6-SHQ_R00k4c2_whPnoY9ruReYU3rHmz74m0ZkGH-VBYe1x0TV6x4yFH8F-HxOezEL3sVTgJtfbYxOLojCN.woff) format('woff')}.material-symbols-sharp{font-family:'Material Symbols Sharp';font-weight:normal;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;font-feature-settings:'liga'}@font-face{font-family:'Material Symbols Sharp';font-style:normal;font-weight:400;font-display:block;src:url(fonts/gNMyW2J8Roq16WD5tFNRaeLQk6-SHQ_R00k4c2_whPnoY9ruReYU3rHmz74m0ZkGH-VBYe1x0TV08dDFHsF-H5uf1kzVR4x9.woff2) format('woff2')}.material-symbols-sharp{font-family:'Material Symbols Sharp';font-weight:normal;font-style:normal;font-size:24px;line-height:1;letter-spacing:normal;text-transform:none;display:inline-block;white-space:nowrap;word-wrap:normal;direction:ltr;-webkit-font-feature-settings:'liga';-webkit-font-smoothing:antialiased}</style></head><body><script>(() => {(function(){var e=window.matchMedia("(prefers-color-scheme: dark)");var t=window.matchMedia("(prefers-reduced-motion: reduce)");function n(e,t){return"".concat(e,"-").concat(t)}function a(e,t,a){var r;(r=document.documentElement.classList).remove.apply(r,a.map((function(t){return n(e,t)})));document.documentElement.classList.add(n(e,t))}function r(e,t,n){var a=new CustomEvent("jmswrnr-settings-change",{detail:{key:e,settingsValue:t,resolvedValue:n}});window.dispatchEvent(a)}function i(){o(k.theme)}function c(){a("theme",y.theme,["dark","light"]);if(k.theme==="auto"){e.addEventListener("change",i)}else{e.removeEventListener("change",i)}}function o(e){var t=u(e);k.theme=e;y.theme=t;r("theme",e,t)}function u(t){if(t==="auto"){return e.matches?"dark":"light"}return t}function s(){a("audio",y.audio,["muted","enabled"]);if(k.audio!=="auto"){p("audio",y.audio)}}function d(e){var t=h(e);k.audio=e;y.audio=t;s();r("audio",e,t)}function h(e){if(e==="auto"){return"muted"}return e}function m(){g(k.graphics)}function f(){a("graphics",y.graphics,["full","reduced"]);if(k.graphics==="auto"){t.addEventListener("change",m)}else{p("graphics",y.graphics);t.removeEventListener("change",m)}}function g(e){var t=l(e);k.graphics=e;y.graphics=t;f();r("graphics",e,t)}function l(e){if(e==="auto"){return t.matches?"reduced":"full"}return e}function v(e){var t=null;try{t=localStorage.getItem("setting-".concat(e))}catch(e){}return t}function p(e,t){try{localStorage.setItem("setting-".concat(e),t)}catch(e){}}var w="dark";var E=v("audio")||"auto";var L=v("graphics")||"auto";var k={theme:w,audio:E,graphics:L};var y={theme:u(w),audio:h(E),graphics:l(L)};window.__jmswrnr_settings={settings:k,resolved:y,setTheme:o,setAudio:d,setGraphics:g};c();s();f()})();})();</script><div id="__next"><div class="Header_appWrapper__eSBqL"><div class="Header_pageWrapper__Y4jzt"><header class="Header_header__VYZ3G"><a aria-label="James Warner Homepage" class="Button_button__HxzDS" href="/"><span class="Button_text__zLCn6"><div class="Header_logo__6vBZG">JMSWRNR<span aria-hidden="true">‚Ñ¢</span></div></span></a><div class="Header_mobiletoggle__ocAF0"><button class="Button_button__HxzDS Button_icononly__HoHJr Button_mobiletoggle__6sgyt"><span aria-hidden="true" class="Button_icon__t4jcZ material-symbols-sharp">menu</span></button></div><nav class="Header_nav__F3t74"><a class="Button_button__HxzDS Button_active__Qp9cc" href="/blog"><span aria-hidden="true" class="Button_icon__t4jcZ material-symbols-sharp">article</span><span class="Button_text__zLCn6">Blog</span></a><a class="Button_button__HxzDS" href="/about"><span aria-hidden="true" class="Button_icon__t4jcZ material-symbols-sharp">person</span><span class="Button_text__zLCn6">About</span></a><div class="Header_icons__g4yPB Header_socials__T_PJV"><a aria-label="Twitter" href="https://twitter.com/jmswrnr" target="_blank" rel="noopener noreferrer" class="Button_button__HxzDS Button_icononly__HoHJr Button_iconlarge__XOtHX Button_twitter__dfXS_"><span aria-hidden="true" class="Button_icon__t4jcZ fa-brands fa-twitter"></span></a><a aria-label="GitHub" href="https://github.com/jmswrnr" target="_blank" rel="noopener noreferrer" class="Button_button__HxzDS Button_icononly__HoHJr Button_iconlarge__XOtHX Button_github__EOGsm"><span aria-hidden="true" class="Button_icon__t4jcZ fa-brands fa-github"></span></a><a aria-label="Instagram" href="https://instagram.com/jmswrnr" target="_blank" rel="noopener noreferrer" class="Button_button__HxzDS Button_icononly__HoHJr Button_iconlarge__XOtHX Button_github__EOGsm"><span aria-hidden="true" class="Button_icon__t4jcZ fa-brands fa-instagram"></span></a></div><div class="HeaderSettings_wrapper___1ZzQ"><button aria-expanded="false" aria-haspopup="menu" id=":R1tn6H1:" class="Button_button__HxzDS Button_icononly__HoHJr"><span aria-hidden="true" class="Button_icon__t4jcZ material-symbols-sharp">settings</span></button></div></nav></header><main class="jsx-3398092431 "><!--$!--><template data-dgst="DYNAMIC_SERVER_USAGE"></template><!--/$--><div class="BlogPost_wrapper__NLC5x BlogPost_cover__2JYmG"><div class="BlogPost_headerImage__CEpq8 BlogPost_color__VomoE"></div><div class="BlogPost_contents__MhVYI"><div class="Layout_columns__Cq4vf Layout_triple__oivnm"><div class="BlogPost_column__pnLKF"><div class="Layout_PageContents__l2q4y"><h1 class="BlogPost_header__RP06Z">Protecting Next.js API Routes: Query¬†Parameters</h1></div></div></div></div></div><div class="BlogPost_wrapper__NLC5x"><div class="Layout_columns__Cq4vf Layout_triple__oivnm"><div class="BlogPost_post__bvIuR"><div class="Layout_PageContents__l2q4y"><p class="BlogPost_description__NrAmQ">How to protect the query parameters of your Next.js API routes from malicious use.</p><div class="BlogPost_meta__P1UPY"><div><div class="BlogPost_label__Np2xQ">Type</div><div class="BlogPost_value__vFfXg">Article</div></div><div><div class="BlogPost_label__Np2xQ">Published</div><div class="BlogPost_value__vFfXg">23 Feb 2023</div></div></div><div id="introduction" class="PageContents_headerHr__65Diz"></div><h2 class="PageContents_h2__YaLWm"><a href="#introduction" title="Introduction" class="PageContents_link__ZpKnq"><span class="PageContents_underline__K0GRf">Introduction</span><span class="PageContents_icon__3SEIn"></span></a></h2><p>When building a Next.js application, creating an API route that accepts query parameters from your pages is a typical pattern. </p><p>For example, my blog uses an API route to serve favicons shown next to external links. Using it to serve the favicon for <a target="_blank" rel="noopener noreferrer nofollow" href="https://google.com" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">Google</span><span class="PageContents_icon__3SEIn"><img alt src="favicon" width="16" height="16" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"></span></a> might look something like this:</p><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#9580ff">GET</span><span> </span><span class="token" style="color:#ff80bf">/</span><span>api</span><span class="token" style="color:#ff80bf">/</span><span>favicon</span><span class="token" style="color:#ff80bf">?</span><span>url</span><span class="token" style="color:#ff80bf">=</span><span>google</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">com</span></span></code></pre></div></div><p>It's also common to use query parameters to resize images:</p><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#9580ff">GET</span><span> </span><span class="token" style="color:#ff80bf">/</span><span>api</span><span class="token" style="color:#ff80bf">/</span><span>image</span><span class="token" style="color:#ff80bf">/</span><span>background</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">jpg</span><span class="token" style="color:#ff80bf">?</span><span>width</span><span class="token" style="color:#ff80bf">=</span><span class="token" style="color:#9580ff">500</span></span></code></pre></div></div><p>Or to update information in a data store, for example, when liking a post:</p><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#9580ff">POST</span><span> </span><span class="token" style="color:#ff80bf">/</span><span>api</span><span class="token" style="color:#ff80bf">/</span><span>posts</span><span class="token" style="color:#ff80bf">/</span><span>like</span><span class="token" style="color:#ff80bf">?</span><span>post_id</span><span class="token" style="color:#ff80bf">=</span><span class="token" style="color:#9580ff">12345</span></span></code></pre></div></div><p>These are great from a developer-experience perspective because the parameters can be easily configured. However, from a security perspective, this simplicity allows anyone to call the API route with any parameter values they want. </p><div id="why" class="PageContents_headerHr__65Diz"></div><h2 class="PageContents_h2__YaLWm"><a href="#why" title="Why?" class="PageContents_link__ZpKnq"><span class="PageContents_underline__K0GRf">Why?</span><span class="PageContents_icon__3SEIn"></span></a></h2><p>Because anyone can use your API route. </p><p>This should always be kept in mind during development and ideally covered in tests; what would happen if a user provides parameters with an unexpected value or malicious intent? And why would anyone want to do that?</p><p>Let's see how the above examples could be maliciously used:</p><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB PageContents_hasBody__XblEK"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#9580ff">GET</span><span> </span><span class="token" style="color:#ff80bf">/</span><span>api</span><span class="token" style="color:#ff80bf">/</span><span>favicon</span><span class="token" style="color:#ff80bf">?</span><span>url</span><span class="token" style="color:#ff80bf">=</span><span>google</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">com</span></span></code></pre></div><p>To resolve a favicon URL, the API route must first fetch the target URL (<code>google.com</code>)</p><p>Malicious users could:</p><ul class="PageContents_ul__eSbnT"><li class="PageContents_li__lXdhg">Use this API route to fetch favicons for their use at your cost.</li><li class="PageContents_li__lXdhg">Send a GET request to any URL using your server by changing the query parameter; this malicious request could bypass network security and even be sent to another API.</li></ul></div><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB PageContents_hasBody__XblEK"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#9580ff">GET</span><span> </span><span class="token" style="color:#ff80bf">/</span><span>api</span><span class="token" style="color:#ff80bf">/</span><span>image</span><span class="token" style="color:#ff80bf">/</span><span>background</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">jpg</span><span class="token" style="color:#ff80bf">?</span><span>width</span><span class="token" style="color:#ff80bf">=</span><span class="token" style="color:#9580ff">500</span></span></code></pre></div><p>Image transformations can be expensive to process and store.</p><p>Malicious users could:</p><ul class="PageContents_ul__eSbnT"><li class="PageContents_li__lXdhg">Use this API route to transform or serve images at your cost.</li><li class="PageContents_li__lXdhg">Send an abnormal number of transformation requests to generate an expensive server bill or deny service to other users.</li></ul></div><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB PageContents_hasBody__XblEK"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#9580ff">POST</span><span> </span><span class="token" style="color:#ff80bf">/</span><span>api</span><span class="token" style="color:#ff80bf">/</span><span>posts</span><span class="token" style="color:#ff80bf">/</span><span>like</span><span class="token" style="color:#ff80bf">?</span><span>post_id</span><span class="token" style="color:#ff80bf">=</span><span class="token" style="color:#9580ff">12345</span></span></code></pre></div><p>Liking a post could perform an "update or insert" query to a data store, correlating a <code>post_id</code> to the number of likes.</p><p>Malicious users could:</p><ul class="PageContents_ul__eSbnT"><li class="PageContents_li__lXdhg">Send an abnormal number of requests with random <code>post_id</code> values, creating many data queries/entries to generate an expensive server bill or deny service to other users.</li></ul></div><p>Although uncommon in smaller projects, from my experience, this type of abuse is almost always expected when delivering to a large audience.</p><div id="protecting-parameters" class="PageContents_headerHr__65Diz"></div><h2 class="PageContents_h2__YaLWm"><a href="#protecting-parameters" title="Protecting parameters" class="PageContents_link__ZpKnq"><span class="PageContents_underline__K0GRf">Protecting parameters</span><span class="PageContents_icon__3SEIn"></span></a></h2><p>A good level of protection can be added to some of these examples:</p><ul class="PageContents_ul__eSbnT"><li class="PageContents_li__lXdhg">Verify the image domain before transforming</li><li class="PageContents_li__lXdhg">Verify the <code>post_id</code> exists in the blog data store before creating new data entries</li></ul><p>This is likely an excellent way to go if you need to accept dynamic input from the user, but this adds a unique complexity to each API route. And how can you protect the favicon route without managing a painful allow list?</p><p>If the query parameters always originate from your application build, there is a pattern we can utilize with all of these examples; <strong>we'll sign them</strong>! ‚úçÔ∏è</p><p>This means we'll create a digital signature during the build step for each combination of query parameters we use. The API routes can verify this signature to ensure the values originate from our build step, preventing malicious users from tampering with or utilizing them for unintended uses.</p><p>I believe JSON Web Tokens (<code>jwt</code>) are an excellent way to achieve this because:</p><ul class="PageContents_ul__eSbnT"><li class="PageContents_li__lXdhg">The encoded format is suitable to include in URLs</li><li class="PageContents_li__lXdhg">Multiple query parameters can be included in the same token</li><li class="PageContents_li__lXdhg"><code>jwt</code> libraries support signing and verification by design</li><li class="PageContents_li__lXdhg">We don't need to bundle additional JavaScript for the browser</li></ul><div id="an-unprotected-example" class="PageContents_headerHr__65Diz"></div><h2 class="PageContents_h2__YaLWm"><a href="#an-unprotected-example" title="An unprotected example" class="PageContents_link__ZpKnq"><span class="PageContents_underline__K0GRf">An unprotected example</span><span class="PageContents_icon__3SEIn"></span></a></h2><p>Here's an example API route without any query protection that returns a message  in a JSON response using the <code>name</code> query parameter:</p><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#7970a9">// pages/api/hello.js</span><span>
</span></span><span>
</span><span><span></span><span class="token module" style="color:#ff80bf">export</span><span> </span><span class="token module" style="color:#ff80bf">default</span><span> </span><span class="token" style="color:#ff80bf">function</span><span> </span><span class="token maybe-class-name" style="color:#8aff80">HelloAPIHandler</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#ffca80">req</span><span class="token" style="color:#f8f8f2">,</span><span class="token" style="color:#ffca80"> res</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>  res</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#8aff80">status</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#9580ff">200</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#8aff80">json</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">{</span><span> </span><span class="token literal-property" style="color:#9580ff">message</span><span class="token" style="color:#ff80bf">:</span><span> </span><span class="token template-string template-punctuation" style="color:#ffff80">`</span><span class="token template-string" style="color:#ffff80">Hello </span><span class="token template-string interpolation interpolation-punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">req</span><span class="token template-string interpolation" style="color:#f8f8f2">.</span><span class="token template-string interpolation property-access">query</span><span class="token template-string interpolation" style="color:#f8f8f2">.</span><span class="token template-string interpolation property-access">name</span><span class="token template-string interpolation interpolation-punctuation" style="color:#f8f8f2">}</span><span class="token template-string" style="color:#ffff80">!</span><span class="token template-string template-punctuation" style="color:#ffff80">`</span><span> </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span></span><span><span></span><span class="token" style="color:#f8f8f2">}</span></span></code></pre></div></div><p>And here is an example page route that uses the <a target="_blank" rel="noopener noreferrer" href="https://swr.vercel.app/" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">SWR library</span><span class="PageContents_icon__3SEIn"></span></a> to fetch and render the API response data:</p><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#7970a9">// pages/index.js</span><span>
</span></span><span>
</span><span><span></span><span class="token module" style="color:#ff80bf">export</span><span> </span><span class="token module" style="color:#ff80bf">default</span><span> </span><span class="token" style="color:#ff80bf">function</span><span> </span><span class="token maybe-class-name" style="color:#8aff80">HomePage</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">{</span><span class="token" style="color:#ffca80"> name </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>  </span><span class="token" style="color:#ff80bf">const</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span> data </span><span class="token" style="color:#f8f8f2">}</span><span> </span><span class="token" style="color:#ff80bf">=</span><span> </span><span class="token" style="color:#8aff80">useSWR</span><span class="token" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation" style="color:#ffff80">`</span><span class="token template-string" style="color:#ffff80">/api/hello?name=</span><span class="token template-string interpolation interpolation-punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">name</span><span class="token template-string interpolation interpolation-punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation" style="color:#ffff80">`</span><span class="token" style="color:#f8f8f2">,</span><span> fetcher</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span></span><span>
</span><span><span>  </span><span class="token control-flow" style="color:#ff80bf">return</span><span> </span><span class="token" style="color:#ff80bf"><</span><span>div</span><span class="token" style="color:#ff80bf">></span><span class="token" style="color:#f8f8f2">{</span><span>data</span><span class="token" style="color:#ff80bf">?.</span><span>message</span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#ff80bf"><</span><span class="token" style="color:#ff80bf">/</span><span>div</span><span class="token" style="color:#ff80bf">></span><span class="token" style="color:#f8f8f2">;</span><span>
</span></span><span><span></span><span class="token" style="color:#f8f8f2">}</span><span>
</span></span><span>
</span><span><span></span><span class="token module" style="color:#ff80bf">export</span><span> </span><span class="token" style="color:#ff80bf">async</span><span> </span><span class="token" style="color:#ff80bf">function</span><span> </span><span class="token" style="color:#8aff80">getStaticProps</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>  </span><span class="token control-flow" style="color:#ff80bf">return</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>    </span><span class="token literal-property" style="color:#9580ff">props</span><span class="token" style="color:#ff80bf">:</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>      </span><span class="token literal-property" style="color:#9580ff">name</span><span class="token" style="color:#ff80bf">:</span><span> </span><span class="token" style="color:#ffff80">'James'</span><span>
</span></span><span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span>
</span></span><span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span></span><span><span></span><span class="token" style="color:#f8f8f2">}</span></span></code></pre></div></div><p>A malicious user could send any value to this API route, even if that value does not originate from your build:</p><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#9580ff">GET</span><span> </span><span class="token" style="color:#ff80bf">/</span><span>api</span><span class="token" style="color:#ff80bf">/</span><span>hello</span><span class="token" style="color:#ff80bf">?</span><span>name</span><span class="token" style="color:#ff80bf">=</span><span>evil</span></span></code></pre></div></div><div id="signing-the-parameters" class="PageContents_headerHr__65Diz"></div><h2 class="PageContents_h2__YaLWm"><a href="#signing-the-parameters" title="Signing the parameters" class="PageContents_link__ZpKnq"><span class="PageContents_underline__K0GRf">Signing the parameters</span><span class="PageContents_icon__3SEIn"></span></a></h2><p>We'll use a secret key to sign and verify the query parameters. We can securely perform the signing during <a target="_blank" rel="noopener noreferrer" href="https://nextjs.org/docs/basic-features/data-fetching/get-static-props" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">getStaticProps</span><span class="PageContents_icon__3SEIn"></span></a> or <a target="_blank" rel="noopener noreferrer" href="https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">getServerSideProps</span><span class="PageContents_icon__3SEIn"></span></a>. This way, we don't expose the key to the browser, so malicious users cannot create signatures for unauthorized payloads.</p><p>One way to ensure this secret key is not exposed is by using environment variables. Next.js will only <a target="_blank" rel="noopener noreferrer" href="https://nextjs.org/docs/basic-features/environment-variables#exposing-environment-variables-to-the-browser" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">expose environment variables</span><span class="PageContents_icon__3SEIn"><img alt src="favicon_1" width="16" height="16" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"></span></a> prefixed with <code>NEXT_PUBLIC_</code> to the browser.</p><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB PageContents_hasBody__XblEK"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-shell" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#7970a9"># .env.local</span><span>
</span></span><span>
</span><span><span></span><span class="token assign-left" style="color:#80ffea">API_QUERY_KEY</span><span class="token" style="color:#ff80bf">=</span><span>secret123</span></span></code></pre></div><p>We can include this in an <code>.env.local</code> to be used locally. </p><p>You'll want to configure your deployment or build process with a secret value. For example, I have configured this in my Vercel project dashboard to have a value like <code>NfpkIkEeMULweVxsZBAd</code>.</p></div><p>We can create and sign the token using the <a target="_blank" rel="noopener noreferrer" href="https://github.com/auth0/node-jsonwebtoken" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">JSON Web Token library</span><span class="PageContents_icon__3SEIn"></span></a>:</p><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB PageContents_hasBody__XblEK"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#7970a9">// pages/index.js</span><span>
</span></span><span>
</span><span><span></span><span class="token module" style="color:#ff80bf">export</span><span> </span><span class="token module" style="color:#ff80bf">default</span><span> </span><span class="token" style="color:#ff80bf">function</span><span> </span><span class="token maybe-class-name" style="color:#8aff80">HomePage</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">{</span><span class="token" style="color:#ffca80"> token </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>  </span><span class="token" style="color:#ff80bf">const</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span> data </span><span class="token" style="color:#f8f8f2">}</span><span> </span><span class="token" style="color:#ff80bf">=</span><span> </span><span class="token" style="color:#8aff80">useSWR</span><span class="token" style="color:#f8f8f2">(</span><span class="token template-string template-punctuation" style="color:#ffff80">`</span><span class="token template-string" style="color:#ffff80">/api/hello?token=</span><span class="token template-string interpolation interpolation-punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">token</span><span class="token template-string interpolation interpolation-punctuation" style="color:#f8f8f2">}</span><span class="token template-string template-punctuation" style="color:#ffff80">`</span><span class="token" style="color:#f8f8f2">,</span><span> fetcher</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span></span><span>  
</span><span><span>  </span><span class="token control-flow" style="color:#ff80bf">return</span><span> </span><span class="token" style="color:#ff80bf"><</span><span>div</span><span class="token" style="color:#ff80bf">></span><span class="token" style="color:#f8f8f2">{</span><span>data</span><span class="token" style="color:#ff80bf">?.</span><span>message</span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#ff80bf"><</span><span class="token" style="color:#ff80bf">/</span><span>div</span><span class="token" style="color:#ff80bf">></span><span class="token" style="color:#f8f8f2">;</span><span>
</span></span><span><span></span><span class="token" style="color:#f8f8f2">}</span><span>
</span></span><span>
</span><span><span></span><span class="token module" style="color:#ff80bf">export</span><span> </span><span class="token" style="color:#ff80bf">async</span><span> </span><span class="token" style="color:#ff80bf">function</span><span> </span><span class="token" style="color:#8aff80">getStaticProps</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>  </span><span class="token control-flow" style="color:#ff80bf">return</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>    </span><span class="token literal-property" style="color:#9580ff">props</span><span class="token" style="color:#ff80bf">:</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>      </span><span class="token literal-property" style="color:#9580ff">token</span><span class="token" style="color:#ff80bf">:</span><span> jwt</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#8aff80">sign</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">{</span><span> </span><span class="token literal-property" style="color:#9580ff">name</span><span class="token" style="color:#ff80bf">:</span><span> </span><span class="token" style="color:#ffff80">'James'</span><span> </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">,</span><span> process</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">env</span><span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#9580ff">API_QUERY_KEY</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>        </span><span class="token literal-property" style="color:#9580ff">subject</span><span class="token" style="color:#ff80bf">:</span><span> </span><span class="token" style="color:#ffff80">'api-hello'</span><span class="token" style="color:#f8f8f2">,</span><span>
</span></span><span><span>      </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">,</span><span>
</span></span><span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">,</span><span>
</span></span><span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">;</span><span>
</span></span><span><span></span><span class="token" style="color:#f8f8f2">}</span><span>
</span></span><span></span></code></pre></div><p>Notice we also provide a subject of <code>api-hello</code>. </p><p>We can use this subject to prevent a signed token from being sent to an unintended API route that uses the same secret key. </p><p>For example, if we created a token to be used with <code>/api/hello</code> without a subject, a malicious user could send that same token to <code>/api/goodbye</code> if it uses the same secret key and payload data structure.</p></div><p>Now we can verify and use this token in the API route:</p><div class="Layout_PageContents__l2q4y PageContents_codeEmbed__8fPG3 PageContents_boxedContent__pG8qB PageContents_hasBody__XblEK"><div class="Layout_PageContents__l2q4y PageContents_codeWrapper__lVPJu"><pre style="color:#f8f8f2;background:#22212c;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;font-size:13px;line-height:20px"><code class="language-javascript" style="color:#f8f8f2;background:none;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:unset;border:none;border-radius:none;font-size:13px;line-height:20px"><span><span class="token" style="color:#7970a9">// pages/api/hello.js</span><span>
</span></span><span>
</span><span><span></span><span class="token module" style="color:#ff80bf">export</span><span> </span><span class="token module" style="color:#ff80bf">default</span><span> </span><span class="token" style="color:#ff80bf">function</span><span> </span><span class="token maybe-class-name" style="color:#8aff80">HelloAPIHandler</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#ffca80">req</span><span class="token" style="color:#f8f8f2">,</span><span class="token" style="color:#ffca80"> res</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>  </span><span class="token control-flow" style="color:#ff80bf">try</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>    </span><span class="token" style="color:#ff80bf">const</span><span> decoded </span><span class="token" style="color:#ff80bf">=</span><span> jwt</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#8aff80">verify</span><span class="token" style="color:#f8f8f2">(</span><span>req</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">query</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">token</span><span class="token" style="color:#f8f8f2">,</span><span> process</span><span class="token" style="color:#f8f8f2">.</span><span class="token property-access">env</span><span class="token" style="color:#f8f8f2">.</span><span class="token" style="color:#9580ff">API_QUERY_KEY</span><span class="token" style="color:#f8f8f2">,</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>      </span><span class="token literal-property" style="color:#9580ff">subject</span><span class="token" style="color:#ff80bf">:</span><span> </span><span class="token" style="color:#ffff80">'api-hello'</span><span class="token" style="color:#f8f8f2">,</span><span>
</span></span><span><span>    </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span></span><span><span>    </span><span class="token control-flow" style="color:#ff80bf">return</span><span> res</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#8aff80">status</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#9580ff">200</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#8aff80">json</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">{</span><span> </span><span class="token literal-property" style="color:#9580ff">message</span><span class="token" style="color:#ff80bf">:</span><span> </span><span class="token template-string template-punctuation" style="color:#ffff80">`</span><span class="token template-string" style="color:#ffff80">Hello </span><span class="token template-string interpolation interpolation-punctuation" style="color:#f8f8f2">${</span><span class="token template-string interpolation">decoded</span><span class="token template-string interpolation" style="color:#f8f8f2">.</span><span class="token template-string interpolation property-access">name</span><span class="token template-string interpolation interpolation-punctuation" style="color:#f8f8f2">}</span><span class="token template-string" style="color:#ffff80">!</span><span class="token template-string template-punctuation" style="color:#ffff80">`</span><span> </span><span class="token" style="color:#f8f8f2">}</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span></span><span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span> </span><span class="token control-flow" style="color:#ff80bf">catch</span><span> </span><span class="token" style="color:#f8f8f2">(</span><span>e</span><span class="token" style="color:#f8f8f2">)</span><span> </span><span class="token" style="color:#f8f8f2">{</span><span>
</span></span><span><span>    </span><span class="token control-flow" style="color:#ff80bf">return</span><span> res</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#8aff80">status</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#9580ff">500</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">.</span><span class="token method property-access" style="color:#8aff80">end</span><span class="token" style="color:#f8f8f2">(</span><span class="token" style="color:#f8f8f2">)</span><span class="token" style="color:#f8f8f2">;</span><span>
</span></span><span><span>  </span><span class="token" style="color:#f8f8f2">}</span><span>
</span></span><span><span></span><span class="token" style="color:#f8f8f2">}</span><span>
</span></span><span></span></code></pre></div><p>If the provided token isn't signed with the correct key or doesn't include the valid subject value, the <code>jwt.verify</code> function will throw an error, and if that occurs in this example, we end the connection with a 500 status code.</p></div><div id="conclusion" class="PageContents_headerHr__65Diz"></div><h2 class="PageContents_h2__YaLWm"><a href="#conclusion" title="Conclusion" class="PageContents_link__ZpKnq"><span class="PageContents_underline__K0GRf">Conclusion</span><span class="PageContents_icon__3SEIn"></span></a></h2><p>That is it! This API route will only accept input as a JSON Web Token signed by your secret key with the correct subject. </p><p>Malicious users are not able to tamper with or create malicious requests. The only requests that will be accepted are those signed by your internal build process. </p><p>A malicious user could repeat a request with the same signed token, but this would likely have little effect if you have a cache layer catching it.</p><p>You could also utilize this same pattern in other applications that consume your API route to ensure the origin of the query payload. Just be careful not to expose the secret key.</p><p>This is somewhat overkill for many API routes. Still, I believe it's a great option if you want to restrict query parameters and reduce potential service abuse, especially on expensive API routes.</p></div></div></div></div></main><footer class="Footer_footer__Tl1eP Footer_mobilePadding__RtHtt"><div class="Footer_links__BOCwF"><div class="Footer_external__jYXye"><div class="Footer_socials__bADcp"><span class="Footer_label___fKJT">Follow me on: </span><a target="_blank" rel="noopener noreferrer nofollow" href="https://twitter.com/jmswrnr" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">Twitter</span><span class="PageContents_icon__3SEIn"><img alt src="favicon_2" width="16" height="16" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"></span></a><a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/jmswrnr" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">GitHub</span><span class="PageContents_icon__3SEIn"><img alt src="favicon_3" width="16" height="16" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"></span></a><a target="_blank" rel="noopener noreferrer nofollow" href="https://instagram.com/jmswrnr" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">Instagram</span><span class="PageContents_icon__3SEIn"><img alt src="favicon_4" width="16" height="16" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"></span></a></div><div class="Footer_builtWith__ctwKE"><span class="Footer_label___fKJT">Built with: </span><span class="Footer_and__4UmtS">‚Ä¢</span><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.sanity.io/" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">Sanity</span><span class="PageContents_icon__3SEIn"><img alt src="favicon_5" width="16" height="16" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"></span></a><span class="Footer_and__4UmtS">‚Ä¢</span><a target="_blank" rel="noopener noreferrer nofollow" href="https://nextjs.org/" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">Next.js</span><span class="PageContents_icon__3SEIn"><img alt src="favicon_8" width="16" height="16" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"></span></a><span class="Footer_and__4UmtS">‚Ä¢</span><a target="_blank" rel="noopener noreferrer nofollow" href="https://threejs.org/" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">Three.js</span><span class="PageContents_icon__3SEIn"><img alt src="favicon_7" width="16" height="16" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"></span></a><span class="Footer_and__4UmtS">‚Ä¢</span><a target="_blank" rel="noopener noreferrer nofollow" href="https://vercel.com/" class="PageContents_link__ZpKnq PageContents_external__7_CR3"><span class="PageContents_underline__K0GRf">Vercel</span><span class="PageContents_icon__3SEIn"><img alt src="favicon_6" width="16" height="16" decoding="async" data-nimg="1" loading="lazy" style="color:transparent"></span></a></div></div><div class="Footer_internal___gtiq"><a title="Blog" class="PageContents_link__ZpKnq PageContents_internal__QrVNw" href="/blog"><span class="PageContents_underline__K0GRf">Blog</span></a><span class="Footer_and__4UmtS">‚Ä¢</span><a title="About" class="PageContents_link__ZpKnq PageContents_internal__QrVNw" href="/about"><span class="PageContents_underline__K0GRf">About</span></a></div></div><div class="Footer_copy__zWR02"><div>Copyright ¬© <!-- -->2023<!-- --> James Warner. All rights reserved. Google<!-- --> <a href="https://www.google.com/intl/en/policies/privacy/" target="_blank" rel="nofollow noopener noreferrer">Privacy Policy</a> <!-- -->and<!-- --> <a href="https://www.google.com/intl/en/policies/terms/" target="_blank" rel="nofollow noopener noreferrer">Terms of Service</a> <!-- -->apply.</div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"preview":false,"post":{"body":[{"_key":"cd24b78a49de","markDefs":[],"children":[{"_key":"02fa9593010c","_type":"span","marks":[],"text":"Introduction"}],"_type":"block","style":"h2"},{"style":"normal","_key":"16c2e7b197bd","markDefs":[],"children":[{"_type":"span","marks":[],"text":"When building a Next.js application, creating an API route that accepts query parameters from your pages is a typical pattern. ","_key":"e4cb95c83d5e"}],"_type":"block"},{"_type":"block","style":"normal","_key":"96f0550cb55e","markDefs":[{"_key":"f353fb3918b3","url":"https://google.com","nofollow":true,"_type":"externalLink"}],"children":[{"_key":"2647051c5a65","_type":"span","marks":[],"text":"For example, my blog uses an API route to serve favicons shown next to external links. Using it to serve the favicon for "},{"text":"Google","_key":"f1e2140023fa","_type":"span","marks":["f353fb3918b3"]},{"_key":"be1ab3dc167c","_type":"span","marks":[],"text":" might look something like this:"}]},{"code":{"language":"javascript","code":"GET /api/favicon?url=google.com","_type":"code"},"_type":"code-embed","_key":"090ed64e8de7"},{"style":"normal","_key":"93a2457e7f59","markDefs":[],"children":[{"_key":"d8554cb3d213","_type":"span","marks":[],"text":"It's also common to use query parameters to resize images:"}],"_type":"block"},{"_key":"4e03eb3679a8","code":{"language":"javascript","code":"GET /api/image/background.jpg?width=500","_type":"code"},"_type":"code-embed"},{"_type":"block","style":"normal","_key":"e42218473edb","markDefs":[],"children":[{"marks":[],"text":"Or to update information in a data store, for example, when liking a post:","_key":"03465ba374ea","_type":"span"}]},{"_key":"ebeda939337a","code":{"_type":"code","language":"javascript","code":"POST /api/posts/like?post_id=12345"},"_type":"code-embed"},{"markDefs":[],"children":[{"_type":"span","marks":[],"text":"These are great from a developer-experience perspective because the parameters can be easily configured. However, from a security perspective, this simplicity allows anyone to call the API route with any parameter values they want. ","_key":"bbf93b936faf"}],"_type":"block","style":"normal","_key":"8adba84ce140"},{"_type":"block","style":"h2","_key":"21a472f1bd1f","markDefs":[],"children":[{"text":"Why?","_key":"b0f4fbce3099","_type":"span","marks":[]}]},{"_type":"block","style":"normal","_key":"3c26b1b3fceb","markDefs":[],"children":[{"_type":"span","marks":[],"text":"Because anyone can use your API route. ","_key":"a83f670f691d"}]},{"markDefs":[],"children":[{"text":"This should always be kept in mind during development and ideally covered in tests; what would happen if a user provides parameters with an unexpected value or malicious intent? And why would anyone want to do that?","_key":"37d07550daf2","_type":"span","marks":[]}],"_type":"block","style":"normal","_key":"8b7f92146577"},{"markDefs":[],"children":[{"_key":"456547772479","_type":"span","marks":[],"text":"Let's see how the above examples could be maliciously used:"}],"_type":"block","style":"normal","_key":"dd8feb6717d4"},{"code":{"_type":"code","language":"javascript","code":"GET /api/favicon?url=google.com"},"_type":"code-embed","_key":"c70157a1cd0f","body":[{"markDefs":[],"children":[{"text":"To resolve a favicon URL, the API route must first fetch the target URL (","_key":"4859df0f564c","_type":"span","marks":[]},{"text":"google.com","_key":"51141d8ff8b2","_type":"span","marks":["code"]},{"_key":"f31ff4831738","_type":"span","marks":[],"text":")"}],"_type":"block","style":"normal","_key":"95ee4ae50aab"},{"children":[{"marks":[],"text":"Malicious users could:","_key":"2517b3173d7f","_type":"span"}],"_type":"block","style":"normal","_key":"47c4e935f111","markDefs":[]},{"listItem":"bullet","markDefs":[],"children":[{"_type":"span","marks":[],"text":"Use this API route to fetch favicons for their use at your cost.","_key":"dc8b2fc1829d"}],"level":1,"_type":"block","style":"normal","_key":"a8d991cbc744"},{"_type":"block","style":"normal","_key":"f76109ddb5c4","listItem":"bullet","markDefs":[],"children":[{"_type":"span","marks":[],"text":"Send a GET request to any URL using your server by changing the query parameter; this malicious request could bypass network security and even be sent to another API.","_key":"b851e5e82dfc"}],"level":1}]},{"body":[{"_type":"block","style":"normal","_key":"899e28181c71","markDefs":[],"children":[{"_type":"span","marks":[],"text":"Image transformations can be expensive to process and store.","_key":"f2fdb4e8f15c"}]},{"style":"normal","_key":"6b8411933721","markDefs":[],"children":[{"_key":"f8a852306b3e","_type":"span","marks":[],"text":"Malicious users could:"}],"_type":"block"},{"_type":"block","style":"normal","_key":"d19d2ad96276","listItem":"bullet","markDefs":[],"children":[{"_type":"span","marks":[],"text":"Use this API route to transform or serve images at your cost.","_key":"c837de726849"}],"level":1},{"_type":"block","style":"normal","_key":"0b570faaa89a","listItem":"bullet","markDefs":[],"children":[{"_key":"feeca31ce0a7","_type":"span","marks":[],"text":"Send an abnormal number of transformation requests to generate an expensive server bill or deny service to other users."}],"level":1}],"code":{"code":"GET /api/image/background.jpg?width=500","_type":"code","language":"javascript"},"_type":"code-embed","_key":"9d37e12c5f49"},{"_type":"code-embed","_key":"8ec11c41400c","body":[{"_key":"47d1da8d07f3","markDefs":[],"children":[{"text":"Liking a post could perform an \"update or insert\" query to a data store, correlating a ","_key":"deccd97c9068","_type":"span","marks":[]},{"_key":"ef3592a8eda2","_type":"span","marks":["code"],"text":"post_id"},{"_type":"span","marks":[],"text":" to the number of likes.","_key":"efeb6c917ea3"}],"_type":"block","style":"normal"},{"style":"normal","_key":"6aeb1f7f6d33","markDefs":[],"children":[{"marks":[],"text":"Malicious users could:","_key":"50edc7d2c506","_type":"span"}],"_type":"block"},{"style":"normal","_key":"df933e22bda4","listItem":"bullet","markDefs":[],"children":[{"_key":"87ca9681c479","_type":"span","marks":[],"text":"Send an abnormal number of requests with random "},{"text":"post_id","_key":"988c0bc5d696","_type":"span","marks":["code"]},{"_key":"9b60adc6cb16","_type":"span","marks":[],"text":" values, creating many data queries/entries to generate an expensive server bill or deny service to other users."}],"level":1,"_type":"block"}],"code":{"_type":"code","language":"javascript","code":"POST /api/posts/like?post_id=12345"}},{"style":"normal","_key":"d17aa0cff079","markDefs":[],"children":[{"text":"Although uncommon in smaller projects, from my experience, this type of abuse is almost always expected when delivering to a large audience.","_key":"e4d39d8f2350","_type":"span","marks":[]}],"_type":"block"},{"children":[{"_type":"span","marks":[],"text":"Protecting parameters","_key":"dbaceb4d15f7"}],"_type":"block","style":"h2","_key":"bfaa95679a08","markDefs":[]},{"style":"normal","_key":"645de540c6aa","markDefs":[],"children":[{"text":"A good level of protection can be added to some of these examples:","_key":"7cd7471a3844","_type":"span","marks":[]}],"_type":"block"},{"children":[{"_type":"span","marks":[],"text":"Verify the image domain before transforming","_key":"1211713aeab0"}],"level":1,"_type":"block","style":"normal","_key":"667f015e62b9","listItem":"bullet","markDefs":[]},{"children":[{"_type":"span","marks":[],"text":"Verify the ","_key":"d7349efc10cd"},{"_type":"span","marks":["code"],"text":"post_id","_key":"ce42c5b36258"},{"marks":[],"text":" exists in the blog data store before creating new data entries","_key":"d2b9f88a831d","_type":"span"}],"level":1,"_type":"block","style":"normal","_key":"c1ce5b362c81","listItem":"bullet","markDefs":[]},{"_key":"f1c381469342","markDefs":[],"children":[{"_key":"d20b4c7b24c5","_type":"span","marks":[],"text":"This is likely an excellent way to go if you need to accept dynamic input from the user, but this adds a unique complexity to each API route. And how can you protect the favicon route without managing a painful allow list?"}],"_type":"block","style":"normal"},{"markDefs":[],"children":[{"_key":"2b75c3985ef5","_type":"span","marks":[],"text":"If the query parameters always originate from your application build, there is a pattern we can utilize with all of these examples; "},{"_type":"span","marks":["strong"],"text":"we'll sign them","_key":"daf942188597"},{"_key":"f131b530e72d","_type":"span","marks":[],"text":"! ‚úçÔ∏è"}],"_type":"block","style":"normal","_key":"881e6b1702c9"},{"style":"normal","_key":"77c6436cf984","markDefs":[],"children":[{"text":"This means we'll create a digital signature during the build step for each combination of query parameters we use. The API routes can verify this signature to ensure the values originate from our build step, preventing malicious users from tampering with or utilizing them for unintended uses.","_key":"113db190ed67","_type":"span","marks":[]}],"_type":"block"},{"_key":"1bbaea9308ad","markDefs":[],"children":[{"marks":[],"text":"I believe JSON Web Tokens (","_key":"06626ff0a00b","_type":"span"},{"_type":"span","marks":["code"],"text":"jwt","_key":"ead00437792a"},{"_type":"span","marks":[],"text":") are an excellent way to achieve this because:","_key":"0fb90db41d2b"}],"_type":"block","style":"normal"},{"listItem":"bullet","markDefs":[],"children":[{"marks":[],"text":"The encoded format is suitable to include in URLs","_key":"a7d6ef9023e1","_type":"span"}],"level":1,"_type":"block","style":"normal","_key":"7b64a45938b6"},{"markDefs":[],"children":[{"text":"Multiple query parameters can be included in the same token","_key":"880748053c7c","_type":"span","marks":[]}],"level":1,"_type":"block","style":"normal","_key":"883a7a9c3e58","listItem":"bullet"},{"_key":"1572e66a0122","listItem":"bullet","markDefs":[],"children":[{"text":"jwt","_key":"223c3996ddf8","_type":"span","marks":["code"]},{"_type":"span","marks":[],"text":" libraries support signing and verification by design","_key":"e176a1f04d55"}],"level":1,"_type":"block","style":"normal"},{"listItem":"bullet","markDefs":[],"children":[{"text":"We don't need to bundle additional JavaScript for the browser","_key":"b12e78b6ec13","_type":"span","marks":[]}],"level":1,"_type":"block","style":"normal","_key":"e040be9599c8"},{"_type":"block","style":"h2","_key":"399154c9cc38","markDefs":[],"children":[{"_type":"span","marks":[],"text":"An unprotected example","_key":"bfaeca4f051e"}]},{"_type":"block","style":"normal","_key":"ea3460426a55","markDefs":[],"children":[{"_key":"2f7e06310e8c","_type":"span","marks":[],"text":"Here's an example API route without any query protection that returns a message  in a JSON response using the "},{"marks":["code"],"text":"name","_key":"5e3b7cddeec1","_type":"span"},{"_type":"span","marks":[],"text":" query parameter:","_key":"9290cd087d1e"}]},{"code":{"language":"javascript","code":"// pages/api/hello.js\r\n\r\nexport default function HelloAPIHandler(req, res) {\r\n  res.status(200).json({ message: `Hello ${req.query.name}!` });\r\n}","_type":"code"},"_type":"code-embed","_key":"97dffb8d9599"},{"markDefs":[{"_type":"externalLink","_key":"6942f80224f1","url":"https://swr.vercel.app/","hideFavicon":true}],"children":[{"_key":"5500dd6bf0c2","_type":"span","marks":[],"text":"And here is an example page route that uses the "},{"_type":"span","marks":["6942f80224f1"],"text":"SWR library","_key":"691a8d577e53"},{"_key":"72e3e369e7ee","_type":"span","marks":[],"text":" to fetch and render the API response data:"}],"_type":"block","style":"normal","_key":"76e0ed82b5f9"},{"_type":"code-embed","_key":"2f51787400ac","code":{"_type":"code","language":"javascript","code":"// pages/index.js\r\n\r\nexport default function HomePage({ name }) {\r\n  const { data } = useSWR(`/api/hello?name=${name}`, fetcher);\r\n\r\n  return \u003cdiv\u003e{data?.message}\u003c/div\u003e;\r\n}\r\n\r\nexport async function getStaticProps() {\r\n  return {\r\n    props: {\r\n      name: 'James'\r\n    }\r\n  }\r\n}"}},{"style":"normal","_key":"f3af8c43de1b","markDefs":[],"children":[{"_key":"546e5138b8fe","_type":"span","marks":[],"text":"A malicious user could send any value to this API route, even if that value does not originate from your build:"}],"_type":"block"},{"_type":"code-embed","_key":"97ea3a59f775","code":{"code":"GET /api/hello?name=evil","_type":"code","language":"javascript"}},{"_type":"block","style":"h2","_key":"39d543b3c846","markDefs":[],"children":[{"_key":"94b836e8dfd8","_type":"span","marks":[],"text":"Signing the parameters"}]},{"markDefs":[{"url":"https://nextjs.org/docs/basic-features/data-fetching/get-static-props","hideFavicon":true,"_type":"externalLink","_key":"8fcd20c41c0b"},{"_type":"externalLink","_key":"ea7cc9cbb7f7","url":"https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props","hideFavicon":true}],"children":[{"_type":"span","marks":[],"text":"We'll use a secret key to sign and verify the query parameters. We can securely perform the signing during ","_key":"8202726d7943"},{"text":"getStaticProps","_key":"f81a37af7802","_type":"span","marks":["8fcd20c41c0b"]},{"_type":"span","marks":[],"text":" or ","_key":"f5e91078aff4"},{"_key":"6b5b4a15c333","_type":"span","marks":["ea7cc9cbb7f7"],"text":"getServerSideProps"},{"marks":[],"text":". This way, we don't expose the key to the browser, so malicious users cannot create signatures for unauthorized payloads.","_key":"ebd717a6731f","_type":"span"}],"_type":"block","style":"normal","_key":"239d4fa52718"},{"markDefs":[{"url":"https://nextjs.org/docs/basic-features/environment-variables#exposing-environment-variables-to-the-browser","_type":"externalLink","_key":"d1e8fdea082f"}],"children":[{"_type":"span","marks":[],"text":"One way to ensure this secret key is not exposed is by using environment variables. Next.js will only ","_key":"7e664c610c2a"},{"_type":"span","marks":["d1e8fdea082f"],"text":"expose environment variables","_key":"aabf6d7f36f3"},{"marks":[],"text":" prefixed with ","_key":"3205e57852ac","_type":"span"},{"text":"NEXT_PUBLIC_","_key":"960c39904680","_type":"span","marks":["code"]},{"text":" to the browser.","_key":"55917009c3aa","_type":"span","marks":[]}],"_type":"block","style":"normal","_key":"0da43d0c70f4"},{"body":[{"_type":"block","style":"normal","_key":"6a5d2d5b3b22","markDefs":[],"children":[{"_type":"span","marks":[],"text":"We can include this in an ","_key":"2017cdac5a4b"},{"marks":["code"],"text":".env.local","_key":"11a6766df0d4","_type":"span"},{"_type":"span","marks":[],"text":" to be used locally. ","_key":"477da6d687a2"}]},{"style":"normal","_key":"2fdc017fd29f","markDefs":[],"children":[{"marks":[],"text":"You'll want to configure your deployment or build process with a secret value. For example, I have configured this in my Vercel project dashboard to have a value like ","_key":"e94ec2359bba","_type":"span"},{"marks":["code"],"text":"NfpkIkEeMULweVxsZBAd","_key":"ff3f677daf4b","_type":"span"},{"marks":[],"text":".","_key":"4fcd7b9080bf","_type":"span"}],"_type":"block"}],"code":{"_type":"code","language":"shell","code":"# .env.local\n\nAPI_QUERY_KEY=secret123"},"_type":"code-embed","_key":"162e52b08461"},{"style":"normal","_key":"4638f5d4c500","markDefs":[{"url":"https://github.com/auth0/node-jsonwebtoken","hideFavicon":true,"_type":"externalLink","_key":"ec00633ae554"}],"children":[{"marks":[],"text":"We can create and sign the token using the ","_key":"0252ac8e2b81","_type":"span"},{"_type":"span","marks":["ec00633ae554"],"text":"JSON Web Token library","_key":"c3d1d5285ed8"},{"text":":","_key":"2639877e225e","_type":"span","marks":[]}],"_type":"block"},{"body":[{"style":"normal","_key":"71e85c153ba9","markDefs":[],"children":[{"text":"Notice we also provide a subject of ","_key":"64ea7e4bd2fb","_type":"span","marks":[]},{"_type":"span","marks":["code"],"text":"api-hello","_key":"10d75fb140d2"},{"_type":"span","marks":[],"text":". ","_key":"4c03d2352516"}],"_type":"block"},{"_type":"block","style":"normal","_key":"ad7161beda9e","markDefs":[],"children":[{"marks":[],"text":"We can use this subject to prevent a signed token from being sent to an unintended API route that uses the same secret key. ","_key":"593c14516a3a","_type":"span"}]},{"markDefs":[],"children":[{"_type":"span","marks":[],"text":"For example, if we created a token to be used with ","_key":"03d494147eac"},{"_type":"span","marks":["code"],"text":"/api/hello","_key":"69252ec05cfa"},{"marks":[],"text":" without a subject, a malicious user could send that same token to ","_key":"349e4982fec1","_type":"span"},{"_type":"span","marks":["code"],"text":"/api/goodbye","_key":"80133bd138b4"},{"text":" if it uses the same secret key and payload data structure.","_key":"a23936106a92","_type":"span","marks":[]}],"_type":"block","style":"normal","_key":"f6f678405d1a"}],"code":{"_type":"code","language":"javascript","code":"// pages/index.js\r\n\r\nexport default function HomePage({ token }) {\r\n  const { data } = useSWR(`/api/hello?token=${token}`, fetcher);\r\n  \r\n  return \u003cdiv\u003e{data?.message}\u003c/div\u003e;\r\n}\r\n\r\nexport async function getStaticProps() {\r\n  return {\r\n    props: {\r\n      token: jwt.sign({ name: 'James' }, process.env.API_QUERY_KEY, {\r\n        subject: 'api-hello',\r\n      }),\r\n    },\r\n  };\r\n}\r\n"},"_type":"code-embed","_key":"6845a58a32d8"},{"markDefs":[],"children":[{"text":"Now we can verify and use this token in the API route:","_key":"1a439c596d02","_type":"span","marks":[]}],"_type":"block","style":"normal","_key":"918aace8dbf5"},{"body":[{"style":"normal","_key":"0c0a46e762bc","markDefs":[],"children":[{"_type":"span","marks":[],"text":"If the provided token isn't signed with the correct key or doesn't include the valid subject value, the ","_key":"8fa52e3cd090"},{"text":"jwt.verify","_key":"2639fbdf86a5","_type":"span","marks":["code"]},{"text":" function will throw an error, and if that occurs in this example, we end the connection with a 500 status code.","_key":"0e64b6969a8d","_type":"span","marks":[]}],"_type":"block"}],"code":{"language":"javascript","code":"// pages/api/hello.js\r\n\r\nexport default function HelloAPIHandler(req, res) {\r\n  try {\r\n    const decoded = jwt.verify(req.query.token, process.env.API_QUERY_KEY, {\r\n      subject: 'api-hello',\r\n    });\r\n    return res.status(200).json({ message: `Hello ${decoded.name}!` });\r\n  } catch (e) {\r\n    return res.status(500).end();\r\n  }\r\n}\r\n","_type":"code"},"_type":"code-embed","_key":"4f18bccc7ad5"},{"markDefs":[],"children":[{"_type":"span","marks":[],"text":"Conclusion","_key":"306474a2bc6c"}],"_type":"block","style":"h2","_key":"74c2dedc9a8a"},{"style":"normal","_key":"5a6e629ebe50","markDefs":[],"children":[{"_type":"span","marks":[],"text":"That is it! This API route will only accept input as a JSON Web Token signed by your secret key with the correct subject. ","_key":"3fc4031ced20"}],"_type":"block"},{"_type":"block","style":"normal","_key":"cfd32a509de8","markDefs":[],"children":[{"_type":"span","marks":[],"text":"Malicious users are not able to tamper with or create malicious requests. The only requests that will be accepted are those signed by your internal build process. ","_key":"4750b0a26c3c"}]},{"children":[{"marks":[],"text":"A malicious user could repeat a request with the same signed token, but this would likely have little effect if you have a cache layer catching it.","_key":"73496d09453e","_type":"span"}],"_type":"block","style":"normal","_key":"c04e916bf1f6","markDefs":[]},{"_type":"block","style":"normal","_key":"0c66aad5f4e9","markDefs":[],"children":[{"_type":"span","marks":[],"text":"You could also utilize this same pattern in other applications that consume your API route to ensure the origin of the query payload. Just be careful not to expose the secret key.","_key":"7bd9b42ff089"}]},{"children":[{"_key":"bf86ba7eff89","_type":"span","marks":[],"text":"This is somewhat overkill for many API routes. Still, I believe it's a great option if you want to restrict query parameters and reduce potential service abuse, especially on expensive API routes."}],"_type":"block","style":"normal","_key":"78e4237835c7","markDefs":[]}],"title":"Protecting Next.js API Routes: Query Parameters","tags":[{"title":"Tutorial","_id":"8d852b5d-36ea-4d50-8e8f-7c12c533dd67","_type":"post-tag","slug":"tutorial"}],"description":"How to protect the query parameters of your Next.js API routes from malicious use.","_updatedAt":"2023-02-23T18:05:29Z","_id":"d820b505-dcac-43e8-bb14-b6a7291b03a1","_type":"post","slug":"protecting-next-js-api-routes-query-parameters","publishedAt":"2023-02-23T16:09:52.402Z"},"clapsToken":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImQ4MjBiNTA1LWRjYWMtNDNlOC1iYjE0LWI2YTcyOTFiMDNhMSIsImlhdCI6MTY5MTQwOTg1Nywic3ViIjoiY2xhcHMtYXBpLWlkIn0.V8xaJ5IdwhG4b-XwbTjYuYhKqG83QaMFSnL9gOfU1_4","bodyMetadata":{"faviconTokens":{"f353fb3918b3":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cmwiOiJodHRwczovL2dvb2dsZS5jb20iLCJpYXQiOjE2OTE0MDk4NTcsInN1YiI6ImZhdmljb24tYXBpLXVybCJ9.tOemalz64Qzyt91TU6nX547owHHEwhSyVG2aRQeMloo","6942f80224f1":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cmwiOiJodHRwczovL3N3ci52ZXJjZWwuYXBwLyIsImlhdCI6MTY5MTQwOTg1Nywic3ViIjoiZmF2aWNvbi1hcGktdXJsIn0.ilYlFllxlwpdbs_VxhqVy-M990nsLeoKABxXtYQTa6U","8fcd20c41c0b":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cmwiOiJodHRwczovL25leHRqcy5vcmcvZG9jcy9iYXNpYy1mZWF0dXJlcy9kYXRhLWZldGNoaW5nL2dldC1zdGF0aWMtcHJvcHMiLCJpYXQiOjE2OTE0MDk4NTcsInN1YiI6ImZhdmljb24tYXBpLXVybCJ9.uamXh6mrgMLVfnsJGkLo-u1thQNWuZlqSD1Ocg-y73g","ea7cc9cbb7f7":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cmwiOiJodHRwczovL25leHRqcy5vcmcvZG9jcy9iYXNpYy1mZWF0dXJlcy9kYXRhLWZldGNoaW5nL2dldC1zZXJ2ZXItc2lkZS1wcm9wcyIsImlhdCI6MTY5MTQwOTg1Nywic3ViIjoiZmF2aWNvbi1hcGktdXJsIn0.p92qZ5-zp435tLdvXm--1Oy2g1XlrxcDYehN3BBKX70","d1e8fdea082f":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cmwiOiJodHRwczovL25leHRqcy5vcmcvZG9jcy9iYXNpYy1mZWF0dXJlcy9lbnZpcm9ubWVudC12YXJpYWJsZXMjZXhwb3NpbmctZW52aXJvbm1lbnQtdmFyaWFibGVzLXRvLXRoZS1icm93c2VyIiwiaWF0IjoxNjkxNDA5ODU3LCJzdWIiOiJmYXZpY29uLWFwaS11cmwifQ.Uxuqe4h30nd0vW3KokCcHKn4WyY-cfoXsOuw1eMowxI","ec00633ae554":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cmwiOiJodHRwczovL2dpdGh1Yi5jb20vYXV0aDAvbm9kZS1qc29ud2VidG9rZW4iLCJpYXQiOjE2OTE0MDk4NTcsInN1YiI6ImZhdmljb24tYXBpLXVybCJ9.AMvww4o4fwCTzMoP7DseIpl287Op_Ht7-OVS3uQU7N0"}}},"__N_SSG":true},"page":"/blog/[post_slug]","query":{"post_slug":"protecting-next-js-api-routes-query-parameters"},"buildId":"aCeeQhfYMqrLmex5-xrBb","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>